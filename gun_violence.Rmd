---
title: "Gun Violence Visualizations"
author: "Erin Guetzloe"
date: "11/18/2019"
output: html_document
---

```{r setup, include=FALSE, cache=TRUE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(readxl)
library(janitor)
library(plotly)
library(reshape2)
library(cowplot)
library(tidyr)
library(gt)

a <- read_xlsx("raw-data/gun-violence-data_01-2013_03-2018.xlsx")

b <- read_xlsx("raw-data/firearm_restrictions_by_state.xlsx")

d <- read_xlsx("raw-data/firearm-mortality-state.xlsx")

join <- full_join(a, b)

join2 <- full_join(join, d)

join3 <- full_join(b, d)

```


```{r plot 1}

mapping <- a %>%
  mutate(year = format(as.Date(a$date, format = "%Y-%M-%d"), "%Y")) %>%
  mutate(n_victims = n_killed + n_injured) %>%
  filter(state == "Massachusetts") %>%
  filter(city_or_county %in% c("Allston", "Arlington", "Boston", "Brighton", "Brookline", "Cambridge", "Cambridge (Cambridgeport)", "Charlestown", "Dorchester", "Dorchester Center", "Hyde Park", "Malden", "Mattapan", "Medford", "Roslindale", "Roxbury", "Somerville", "South Boston", "Watertown", "West Roxbury")) %>%
  filter(year != 2018) %>%
  select(year, n_victims)

plot1 <- ggplot(mapping, aes(x = year, y = n_victims, fill = "orange")) +
  geom_col(width = 0.4) +
  labs(x = "Year", y = "Number of Victims", title = "Gun Violence in Boston and the Greater Boston Area", caption = "2018 data not included because it only extends from January through March of 2018.") +
  theme(legend.position = "none")

ggplotly(plot1)

```

```{r plot 2}

mapping2 <- a %>%
  mutate(year = format(as.Date(a$date, format = "%Y-%M-%d"), "%Y")) %>%
  filter(state == "Massachusetts") %>%
  filter(city_or_county %in% c("Allston", "Arlington", "Boston", "Brighton", "Brookline", "Cambridge", "Cambridge (Cambridgeport)", "Charlestown", "Dorchester", "Dorchester Center", "Hyde Park", "Malden", "Mattapan", "Medford", "Roslindale", "Roxbury", "Somerville", "South Boston", "Watertown", "West Roxbury")) %>%
  filter(year != 2018) %>%
  select(year, n_injured)

plot2 <- ggplot(mapping2, aes(x = year, y = n_injured, fill = "orange")) +
  geom_col(width = 0.4) +
  labs(x = "Year", y = "Number of Victims Injured", title = "Gun-related Injuries in Boston and the Greater Boston Area") +
  theme(legend.position = "none")

ggplotly(plot2)

```

```{r}

mapping3 <- a %>%
  mutate(year = format(as.Date(a$date, format = "%Y-%M-%d"), "%Y")) %>%
  filter(state == "Massachusetts") %>%
  filter(city_or_county %in% c("Allston", "Arlington", "Boston", "Brighton", "Brookline", "Cambridge", "Cambridge (Cambridgeport)", "Charlestown", "Dorchester", "Dorchester Center", "Hyde Park", "Malden", "Mattapan", "Medford", "Roslindale", "Roxbury", "Somerville", "South Boston", "Watertown", "West Roxbury")) %>%
  filter(year != 2013) %>%
  filter(year != 2018) %>%
  select(year, n_killed)

plot3 <- ggplot(mapping3, aes(x = year, y = n_killed, fill = "orange")) +
  geom_col(width = 0.4) +
  labs(x = "Year", y = "Number of Victims Killed", title = "Gun-related Deaths in Boston and the Greater Boston Area") +
  theme(legend.position = "none")

ggplotly(plot3)

```

```{r regression}

regdata <- join2 %>%
  filter(state == "Massachusetts") %>%
  filter(year %in% c(2014, 2015, 2016, 2017)) %>%
  select(deaths, lawtotal, year) 
  
regression <- lm(deaths ~ year, data = regdata, family = "binomial")

graph <- ggplot(regression, aes(x = year, y = deaths)) +
  geom_point() +
  geom_smooth(method = "lm", color = "orange") +
  ggtitle("Massachusetts Deaths from Gun Violence, 2014-2017") +
  xlab("Year") +
  ylab("Number of Deaths")

ggplotly(graph)

```

```{r}

mapping4 <- join2 %>%
  filter(state %in% c("Massachusetts", "Pennsylvania", "Wisconsin")) %>%
  filter(city_or_county %in% c("Allston", "Arlington", "Boston", "Brighton", "Brookline", "Cambridge", "Cambridge (Cambridgeport)", "Charlestown", "Dorchester", "Dorchester Center", "Hyde Park", "Malden", "Mattapan", "Medford", "Roslindale", "Roxbury", "Somerville", "South Boston", "Watertown", "West Roxbury", "Milwaukee", "Philadelphia")) %>%
  mutate(city_or_county = ifelse(city_or_county %in% c("Allston", "Arlington", "Boston", "Brighton", "Brookline", "Cambridge", "Cambridge (Cambridgeport)", "Charlestown", "Dorchester", "Dorchester Center", "Hyde Park", "Malden", "Mattapan", "Medford", "Roslindale", "Roxbury", "Somerville", "South Boston", "Watertown", "West Roxbury"), "Greater Boston", city_or_county))

group <- mapping4 %>%
  group_by(city_or_county) %>%
  count()

```

```{r}

accumulate_by <- function(dat, var) {

  var <- lazyeval::f_eval(var, dat)

  lvls <- plotly:::getLevels(var)

  dats <- lapply(seq_along(lvls), function(x) {

    cbind(dat[var %in% lvls[seq(1, x)], ], frame = lvls[[x]])

  })

  dplyr::bind_rows(dats)

}

mapping5 <- a %>%
  mutate(year = format(as.Date(a$date, format = "%Y-%M-%d"), "%Y")) %>%
  filter(state %in% c("Massachusetts", "Pennsylvania", "Wisconsin")) %>%
  filter(city_or_county %in% c("Allston", "Arlington", "Boston", "Brighton", "Brookline", "Cambridge", "Cambridge (Cambridgeport)", "Charlestown", "Dorchester", "Dorchester Center", "Hyde Park", "Malden", "Mattapan", "Medford", "Roslindale", "Roxbury", "Somerville", "South Boston", "Watertown", "West Roxbury", "Milwaukee", "Philadelphia")) %>%
  mutate(city_or_county = ifelse(city_or_county %in% c("Allston", "Arlington", "Boston", "Brighton", "Brookline", "Cambridge", "Cambridge (Cambridgeport)", "Charlestown", "Dorchester", "Dorchester Center", "Hyde Park", "Malden", "Mattapan", "Medford", "Roslindale", "Roxbury", "Somerville", "South Boston", "Watertown", "West Roxbury"), "Greater Boston", city_or_county)) %>%
  filter(year != 2013) %>%
  filter(year != 2018) %>%
  count(city_or_county, year)

saveRDS(object = mapping5, file = "gun-violence-visualizations/violence_by_year.rds")

```

```{r}

mapping6 <- a %>%
   mutate(year = format(as.Date(a$date, format = "%Y-%M-%d"), "%Y")) %>%
  select(n_injured, n_killed, year)
  
#meltedmapping6 <- melt(mapping6)

#ggplot(meltedmapping6, aes(, year,fill=variable))+
     geom_bar(stat="identity",position="dodge")

mapping6 %>%
  gather("n_injured", -year) %>%
  ggplot(aes(year, n_injured, fill = year)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_bw()

```

```{r}

filtered_b <- b %>%
  filter(state %in% c("Massachusetts", "Wisconsin", "Pennsylvania")) %>%
  filter(year %in% c(2014, 2015, 2016, 2017))

filtered_b2 <- b %>%
  filter(state %in% c("Massachusetts", "California")) %>%
  filter(year %in% c(2014, 2015, 2016, 2017))

```


```{r}

mapping7 <- join3 %>%
  filter(state == "Massachusetts") %>%
  select(year, lawtotal)

gt(mapping7) %>%
  labs(title = "Number of Massachusetts Gun Laws 2014-2017")

```

